# 0x5 免杀技术

免杀技术是现代网络攻防对抗的核心，涉及反检测、反沙箱、反虚拟化等多个层面。

## 📚 技术问答

### 🛡️ 免杀基础
- **平时怎么做的免杀？**
- **你测试免杀的时候开不开网络，开不开云传，为什么？**
- **你平时使用哪种语言写木马，选择这种语言的原因是什么？**
- **为什么木马自己cmd运行不被杀，但是钓鱼时就会被杀？**

### 🏖️ 反沙箱技术
- **常见的反沙箱手段有哪些？**

### 💻 反虚拟机
- **常见的反虚拟机手段有哪些？**

### 🔧 Shellcode技术
- **你的Shellcode Loader中会使用哪些技术点？**
- **Sleepmask原理是什么，其本身是否有特征？**

### 🎯 特定杀软绕过
- **怎么规避360 QVM？**
- **知不知道天擎的检测点，怎么绕过？**
- **有没有对抗过卡巴斯基，有哪些检测点？**

### 🔐 权限维持
- **权限维持怎么绕过常见的杀软？**

### 🧰 Cobalt Strike
- **有没有研究过Cobalt Strike的Kit？**

### 💉 进程注入
- **进程注入的步骤？**

### 📚 DLL相关
- **有没有挖过DLL劫持，怎么挖的？**
- **怎么解决DLL劫持利用的死锁问题？**

### ⚙️ 系统调用
- **是否了解syscall的原理和分类？**

### 🌐 Webshell免杀
- **有没有做过webshell的免杀，具体会怎么做？**

### 🔨 工具免杀
- **对于工具的免杀，有源码和无源码的情况下你分别会怎么做？**

### 🛡️ 系统防护
- **如何绕过新下载文件打开时的告警（smartscreen机制）？**

### 🔍 检测机制
- **是否了解杀软的各种查杀机制特性，以及如何绕过这些机制？**
- **是否知道哪些可以规避杀软的抓取哈希的方法？**

### 💀 BYOVD技术
- **有没有了解过BYOVD？**

### 👁️ EDR对抗
- **EDR致盲的原理是什么？**
- **360核晶的检测拦截内容包括哪些？**

### 🔧 AMSI绕过
- **怎么绕过AMSI？**

### ⚡ 高级技术
- **BOF、execute-assembly的原理是什么，有什么区别？**

---

## 🎯 免杀技术分类

### 静态免杀
```cpp
// 代码混淆示例
#define CALC "calc.exe"
char cmd[] = {0x63,0x61,0x6c,0x63,0x2e,0x65,0x78,0x65,0x00};

// 字符串加密
void decrypt(char* data, int len) {
    for(int i = 0; i < len; i++) {
        data[i] ^= 0x88;
    }
}
```

### 动态免杀
```cpp
// 内存加载
LPVOID pShellcode = VirtualAlloc(NULL, dwSize, 
    MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
memcpy(pShellcode, shellcode, dwSize);

// 进程注入
CreateRemoteThread(hProcess, NULL, 0, 
    (LPTHREAD_START_ROUTINE)pRemoteCode, pRemoteData, 0, NULL);
```

## 🛠️ 核心技术

### 1. 反检测技术
- **反沙箱** - 检测分析环境
- **反调试** - 阻止动态分析
- **反虚拟机** - 识别虚拟化环境
- **反HOOK** - 绕过API监控

### 2. 代码混淆
- **控制流混淆** - 复杂化程序逻辑
- **数据混淆** - 加密敏感字符串
- **指令替换** - 等价指令变换
- **垃圾代码** - 插入无关指令

### 3. 加壳技术
- **压缩壳** - 压缩可执行文件
- **加密壳** - 加密代码段
- **虚拟机壳** - 虚拟机保护
- **多态壳** - 变形加密算法

### 4. 内存执行
- **反射DLL** - 内存加载DLL
- **进程挖空** - Process Hollowing
- **内存补丁** - 运行时修改
- **无文件攻击** - Fileless Attack

## 📊 杀软检测机制

### 静态检测
| 检测方式 | 原理 | 绕过方法 |
|----------|------|----------|
| 特征码检测 | 匹配已知恶意代码片段 | 代码变形、多态引擎 |
| 哈希检测 | 文件MD5/SHA1对比 | 添加垃圾数据 |
| 熵值检测 | 计算文件随机性 | 降低代码熵值 |
| PE结构检测 | 分析可执行文件格式 | 修改PE头结构 |

### 动态检测
| 检测方式 | 原理 | 绕过方法 |
|----------|------|----------|
| 行为检测 | 监控API调用 | API HOOK绕过 |
| 沙箱检测 | 虚拟环境执行 | 反沙箱技术 |
| 启发式检测 | 基于行为规则 | 正常行为模拟 |
| 机器学习 | AI模型判断 | 对抗样本生成 |

## 🔧 常用工具

### 免杀框架
- **Veil** - Python免杀框架
- **TheFatRat** - 恶意软件生成工具
- **MSFvenom** - Metasploit载荷生成器
- **Shellter** - 动态shellcode注入

### 代码混淆
- **ConfuserEx** - .NET混淆工具
- **VMProtect** - 商业虚拟机保护
- **Themida** - 商业软件保护
- **UPX** - 可执行文件压缩

### 分析工具
- **PEiD** - 壳检测工具
- **Die** - 文件分析工具
- **Process Monitor** - 进程监控
- **API Monitor** - API调用监控

## 💡 免杀思路

### 1. 分离技术
```
载荷分离 → 远程加载 → 内存执行
```

### 2. 白名单绕过
```
合法程序 → DLL劫持 → 恶意代码执行
```

### 3. 签名伪造
```
数字证书 → 签名文件 → 绕过检测
```

### 4. 时间延迟
```
Sleep函数 → 延迟执行 → 逃避沙箱
```

---

## 🎖️ 免杀等级

### 🥉 基础级 (初级)
- 简单编码/加密
- 修改文件头信息
- 添加垃圾代码

### 🥈 进阶级 (中级)
- 多态引擎
- 反调试技术
- API动态加载

### 🥇 专业级 (高级)
- 内核级HOOK
- Rootkit技术
- 0day利用

### 🏆 大师级 (专家)
- 固件级持久化
- 硬件辅助虚拟化
- APT级别隐蔽

---

> 🛡️ **免杀心得**: 免杀技术是攻防对抗的核心，需要深入理解操作系统原理和安全软件机制。技术在不断演进，学习永无止境。

⚠️ **免责声明**: 本内容仅供安全研究和防护目的使用，请勿用于非法用途。
